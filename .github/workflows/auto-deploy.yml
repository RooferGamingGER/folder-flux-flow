name: Auto-Deploy to Self-Hosted Server

on:
  push:
    branches: 
      - main
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update Type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            
            echo "üöÄ Starting deployment..."
            
            cd /opt/nobis
            
            # Full Update oder Quick Update?
            if [ "${{ github.event.inputs.update_type }}" = "quick" ]; then
              echo "üì¶ Running quick update (frontend only)..."
              sudo ./nobis.sh update --quick
            else
              echo "üì¶ Running full update..."
              sudo ./nobis.sh update
            fi
            
            echo "‚úÖ Deployment completed successfully!"
            
      - name: Health Check
        uses: appleboy/ssh-action@v1.0.0
        if: success()
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "üè• Running health checks..."
            sudo /opt/nobis/nobis.sh status
            
      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üìä Check status at: https://${{ secrets.DOMAIN }}"
          
      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs: sudo /opt/nobis/nobis.sh logs"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Automatic Rollback
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "üîÑ Attempting automatic rollback..."
            
            cd /opt/nobis
            
            # Finde neuestes pre_update Backup
            LATEST_BACKUP=$(ls -t /var/backups/nobis/nobis_pre_update_*.tar.gz 2>/dev/null | head -1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "Found backup: $LATEST_BACKUP"
              echo "1" | sudo ./nobis.sh restore
              echo "‚úÖ Rollback completed"
            else
              echo "‚ùå No backup found for rollback"
              exit 1
            fi
